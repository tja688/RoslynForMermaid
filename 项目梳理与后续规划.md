# ArchRadar 项目梳理与后续规划

更新时间：2025-12-26

## 1. 项目目标（对照设计案 v3）

目标一句话：将代码扫描生成的 Audit 图（L0/L1/L2）沉淀为可管理的 Snapshot 资产，并通过自研前端工作台实现可视化浏览、交互导航与源码定位，后端以 .NET 常驻服务统一管理与对接。  
核心交付包含：

- **.NET 后端服务**：扫描调度、Workspace 数据管理、API 提供、Open-in-Editor。
- **frontend-ui 前端**：主题/背景/字体 + Mermaid 预览引擎 + 工作台 UI。
- **Core/CLI 扫描能力**：Roslyn 分析 + 输出 audit.json/L0/L1/L2。

## 2. 现有实现盘点（已完成部分）

### 2.1 ArchRadar.Core（核心库）

已具备基础扫描/建图/输出能力：

- **扫描模式**：DirectoryOnly 与 MsBuildSolution 两种模式可用。  
  相关实现：`ArchRadar.Core/Scanning/DirectoryAuditScanner.cs`、`ArchRadar.Core/Scanning/MsBuildAuditScanner.cs`
- **Roslyn 语法/语义采集**：当前支持 Class/Invocation/ObjectCreation，并记录 callsite。  
  相关实现：`ArchRadar.Core/Scanning/CSharpAuditWalker.cs`
- **Feature 归属规则**：按命名空间/目录规则匹配并提供 fallback。  
  相关实现：`ArchRadar.Core/Rules/FeatureRuleEngine.cs`
- **Audit 图模型**：节点/边/置信度/调用点可用。  
  相关实现：`ArchRadar.Core/Models/*`
- **输出**：audit.json + Mermaid L0/L1/L2。  
  相关实现：`ArchRadar.Core/Output/AuditJsonWriter.cs`、`ArchRadar.Core/Output/MermaidWriter.cs`
- **外部折叠**：支持将外部依赖合并为 External 组。  
  相关实现：`ArchRadar.Core/Processing/ExternalFoldingProcessor.cs`

### 2.2 ArchRadar.Cli（命令行工具）

已实现一键扫描并输出快照内容：

- 读取 `.archradar/config.json`（或 `archradar.config.json`）。
- 输出结构：`<target>/.archradar/snapshots/<timestamp>/L0|L1|L2/`。
- 默认 L2 配置使用内置值（并未读取配置 L2）。

相关实现：`ArchRadar.Cli/Program.cs`

### 2.3 frontend-ui（前端工作台）

已完成“Preview 引擎 + API 接入骨架”的 MVP：

- Mermaid 预览渲染可用（主题/背景/字体切换、SVG 导出）。
  - `frontend-ui/src/components/MermaidPreview/MermaidPreview.tsx`
- API 接口层完成（mock + baseUrl）。
  - `frontend-ui/src/services/api.ts`、`frontend-ui/src/services/mockApi.ts`
- 基础工作台 UI（项目/快照/层级选择 + 预览区）。
  - `frontend-ui/src/app/App.tsx`

### 2.4 设计案对齐情况

- v3 目标明确需要 **.NET 常驻后端 + 自研前端**。
- 当前缺失的是 **后端服务、工作台交互深化、数据存储规范化**。

## 3. 关键缺口（与设计目标对照）

### 3.1 后端服务缺失（最高优先级）

尚无 .NET 服务项目，无法提供以下功能：

- Workspace 数据管理（catalog/project profile/snapshot index）。
- 扫描调度（调用 Core/CLI）并沉淀到 workspace。
- API 对前端提供项目/快照/图层/图内容。
- Open-in-Editor（源码定位）。

### 3.2 数据与输出格式未完全对齐

设计案要求：

- Snapshot 文件位于 workspace（如 `%AppData%/ArchRadar/`），而当前 CLI 输出在项目目录的 `.archradar/`。
- 快照期望结构为 `snapshots/<timestamp>/L0.mmd / L1_*.mmd / L2_*.mmd`，当前 CLI 使用 `L0/ L1/ L2/` 子目录。
- 需要 `index.json`、`catalog.json` 等管理性 JSON，当前尚未生成。
- Mermaid 中节点 ID 必须稳定（用于点击绑定），当前 `MermaidWriter` 使用 `F0/N0` 序号，不满足要求。

### 3.3 语义完整度不足

当前 CSharpAuditWalker 仅处理：

- Class 声明、调用（Invocation）、实例化（Creation）

尚未覆盖：

- 字段/属性/参数/返回类型等 UsesType 边。
- 继承/实现/泛型约束等类型关系。
- NodeKind 的细分（Controller/System/Model/Command/Query 等）。

### 3.4 前端交互尚为骨架

当前前端只具备：

- 预览 + 选择数据源 + 简单列表。
- 节点点击仅打印日志。

缺失：

- L0/L1/L2 点击下钻的稳定绑定与导航。
- Node/Edge Inspector，callsites 列表。
- 右键菜单、边类型过滤、lint overlay。

## 4. 结论：是否直接开始 .NET 后端？

结论：可以开始 .NET 后端，但需要先确定**数据契约与输出格式**，否则后端与前端的对接会重复返工。  
建议的顺序是：

1. **先定数据契约与快照格式**（NodeId 规则、快照目录结构、API contract）。  
2. **并行搭建后端服务骨架**（提供 health/projects/snapshots/layers/diagram）。  
3. **再逐步补齐 Core 输出与前端交互**。

## 5. .NET 后端开发规划（建议顺序）

### 5.1 规划阶段（1-2 天）

- 定义 workspace 根路径策略：`%AppData%/ArchRadar/`（Windows）或 `LocalApplicationData`。
- 定义 snapshot 目录结构与 index.json schema。
- 定义 Mermaid 节点 ID 生成规范（例如：`nodeId = hash(auditNode.Id)` + 映射表）。
- 定义 API contract（当前前端已固定 5 个接口，需要补充 Open/Inspect）。

### 5.2 后端工程骨架（2-4 天）

新建 `ArchRadar.Server`（或 `ArchRadar.Backend`）：

- ASP.NET Core Minimal API。
- `GET /api/health`
- `GET /api/projects`
- `GET /api/projects/{projectId}/snapshots`
- `GET /api/projects/{projectId}/snapshots/{snapshotId}/layers`
- `GET /api/projects/{projectId}/snapshots/{snapshotId}/diagram?layer=...`
- 静态资源托管 frontend-ui 的 build 产物（生产态）。

### 5.3 Workspace 数据层（3-5 天）

实现 JSON-only 持久化：

- `catalog.json`：项目列表、最近访问。
- `projects/<projectId>/profile.json`：project root、默认扫描入口、规则配置。
- `snapshots/<snapshotId>/index.json`：统计信息、配置快照。
- 所有写入遵循“临时文件 → 原子替换”。

### 5.4 扫描调度与产出（4-6 天）

- 后端调用 Core（或复用 CLI 逻辑）执行扫描。
- 输出 audit.json + L0/L1/L2 到 workspace。
- 更新 catalog 与 snapshot index。
- 提供新增接口：`POST /api/projects/{projectId}/scan`（触发扫描）。

### 5.5 交互能力补齐（并行）

后端补齐定位与检查能力：

- `POST /api/open` 或 `GET /api/open?file=...&line=...`。
- `GET /api/projects/{projectId}/snapshots/{snapshotId}/audit`（供 Inspector 使用）。
- 为 Node/Edge 提供读取 API（方便前端 Inspector 展示）。

## 6. 后续完整路线图（直到完成）

### Phase 2（后端 + 基础对接完成后）

- 前端实现 L0/L1/L2 下钻与稳定节点绑定。
- Inspector 展示节点/边/调用点。
- 点击 callsite -> 调用后端 Open-in-Editor。

### Phase 3（体验完善）

- lint overlay 与违规定位（读取 lint.json）。
- Edge/Node 过滤与搜索。
- Snapshot 对比与差异高亮（后续可选）。

### Phase 4（交付与产品化）

- 打包与安装（单端口部署）。
- 最小 CI 流程（构建后端 + 前端）。
- 文档化运行与配置。

## 7. 风险与待确认事项

- NodeId 与 Mermaid DOM 的稳定绑定规范需要尽快确认。
- Snapshot 输出结构需在后端与 CLI 之间统一。
- Roslyn 语义深度可能需要扩展（当前 UsesType 等边未生成）。
- .NET target 为 net10.0（需确认运行环境已稳定）。
